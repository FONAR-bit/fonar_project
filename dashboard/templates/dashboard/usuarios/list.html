{% extends "dashboard/base.html" %}
{% block content %}
<h2>Usuarios</h2>

<form method="get" class="mb-3 row g-2">
  <div class="col-md-3">
    <input type="text" name="q" class="form-control" placeholder="Buscar por usuario o email..." value="{{ request.GET.q }}">
  </div>

  <div class="col-md-2">
    <select name="activo" class="form-select">
      <option value="">-- Activo --</option>
      <option value="1" {% if request.GET.activo == "1" %}selected{% endif %}>Sí</option>
      <option value="0" {% if request.GET.activo == "0" %}selected{% endif %}>No</option>
    </select>
  </div>

  <div class="col-md-2">
    <select name="staff" class="form-select">
      <option value="">-- Staff --</option>
      <option value="1" {% if request.GET.staff == "1" %}selected{% endif %}>Sí</option>
      <option value="0" {% if request.GET.staff == "0" %}selected{% endif %}>No</option>
    </select>
  </div>

  <!-- 👇 Nuevo filtro -->
  <div class="col-md-3">
    <select name="tipo_usuario" class="form-select">
      <option value="">-- Tipo de Usuario --</option>
      <option value="asociado" {% if request.GET.tipo_usuario == "asociado" %}selected{% endif %}>Asociado</option>
      <option value="tercero" {% if request.GET.tipo_usuario == "tercero" %}selected{% endif %}>Tercero</option>
    </select>
  </div>

  <div class="col-md-2">
    <button type="submit" class="btn btn-primary w-100">🔍 Filtrar</button>
  </div>
</form>

<a href="{% url 'dashboard:usuarios-create' %}" class="btn btn-success mb-3">➕ Nuevo Usuario</a>

<table class="table table-striped">
  <thead>
    <tr>
      <th>Usuario</th>
      <th>Nombre</th>
      <th>Apellido</th>
      <th>Email</th>
      <th>Tipo de Usuario</th>
      <th>Activo</th>
      <th>Staff</th>
      <th>Último acceso</th>
      <th>Creado en</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for u in usuarios %}
      <tr>
        <td>{{ u.username }}</td>
        <td>{{ u.first_name }}</td>
        <td>{{ u.last_name }}</td>
        <td>{{ u.email }}</td>
        <td>
          {% if u.tipo_usuario == "asociado" %}
            🟢 Asociado
          {% elif u.tipo_usuario == "tercero" %}
            🔵 Tercero
          {% else %}
            ⚪ -
          {% endif %}
        </td>
        <td>{{ u.is_active|yesno:"✅,❌" }}</td>
        <td>{{ u.is_staff|yesno:"✅,❌" }}</td>
        <td>{% if u.last_login %}{{ u.last_login|date:"d/m/Y H:i" }}{% else %}Nunca{% endif %}</td>
        <td>{{ u.date_joined|date:"d/m/Y" }}</td>
        <td>
          <a href="{% url 'dashboard:usuarios-update' u.id %}" class="btn btn-warning btn-sm">✏️</a>
          <a href="{% url 'dashboard:usuarios-delete' u.id %}" class="btn btn-danger btn-sm">🗑️</a>
        </td>
      </tr>
    {% empty %}
      <tr><td colspan="10">No hay usuarios.</td></tr>
    {% endfor %}
  </tbody>
</table>

{% if is_paginated %}
  <nav>
    <ul class="pagination">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?{% if params %}{{ params }}&{% endif %}page={{ page_obj.previous_page_number }}">Anterior</a>
        </li>
      {% endif %}
      <li class="page-item disabled">
        <span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
      </li>
      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?{% if params %}{{ params }}&{% endif %}page={{ page_obj.next_page_number }}">Siguiente</a>
        </li>
      {% endif %}
    </ul>
  </nav>
{% endif %}
{% endblock %}
