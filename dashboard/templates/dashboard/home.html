{% extends "dashboard/base.html" %}
{% load humanize %}

<style>
  /* Mantiene scroll horizontal limpio */
  .table-responsive {
    overflow-x: auto;
  }

  /* Evita que las celdas hagan wrap por defecto */
  .table-nowrap {
    table-layout: auto;
    width: auto;
  }

  th, td {
    vertical-align: middle;
  }

  th.col-nombre,
  td.col-nombre {
    white-space: nowrap;
    min-width: 280px;
  }
</style>

{% block content %}
<div class="row justify-content-between align-items-center mb-3">
    <div class="col-md-8 text-start">
        <h1 class="mb-0">üëã Bienvenido al Panel de Administraci√≥n</h1>
        <p class="lead mb-0">Resumen financiero de socios en {{ a√±o_actual }}</p>
    </div>
    <div class="col-md-3 text-end">
        <form method="get">
            <select name="year" class="form-select mb-2" onchange="this.form.submit()">
                {% for y in a√±os_disponibles %}
                    <option value="{{ y }}" {% if y == a√±o_actual %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </form>

        <a href="{% url 'dashboard:entregar_fondo' %}?year={{ a√±o_actual }}"
           class="btn btn-danger w-100" target="_blank">
            üìÑ Entregar Fondo
        </a>
    </div>
</div>

<div class="row justify-content-center mt-3">
    <div class="col-md-12">
        <div class="table-responsive">
            <table class="table table-bordered table-striped table-sm table-nowrap">
                <thead class="table-dark text-center">
                    <tr>
                        <th class="col-nombre">Nombre</th>
                        <th>Correo</th>
                        <th>Estado</th>
                        <th>Fecha Ingreso</th>

                        <th>Total Aportes</th>
                        <th>Aportes Viaje</th>

                        <th>Intereses Pagados</th>
                        <th>Capital Pendiente</th>
                        <th>% Participaci√≥n</th>
                        <th>D√≠as Vinculaci√≥n</th>

                        <th>Intereses Ganados</th>
                        <th>Recaudo Actividad</th>

                        <th>% Rentabilidad</th>
                        <th>√öltimo Aporte</th>
                        <th>Estado Mora</th>
                        <th>Pago Administraci√≥n</th>
                        <th>Intereses a Pagar</th>
                        <th>Total a Pagar</th>

                        <!-- ‚úÖ NUEVO: Columna final -->
                        <th>Administraci√≥n APP</th>
                    </tr>
                </thead>

                <tbody>
                    {% for u in usuarios_data %}
                    <tr {% if u.nombre == "Terceros" %}class="table-warning fw-bold"{% endif %}>
                        <td class="col-nombre">{{ u.nombre }}</td>
                        <td>{{ u.email }}</td>
                        <td class="text-center">{{ u.estado_usuario }}</td>
                        <td class="text-center">
                            {% if u.fecha_ingreso %}{{ u.fecha_ingreso|date:"d/m/Y" }}{% else %}-{% endif %}
                        </td>

                        <td class="text-end">${{ u.total_aportes|floatformat:0|intcomma }}</td>
                        <td class="text-end">${{ u.total_aportes_viaje|floatformat:0|intcomma }}</td>

                        <td class="text-end">${{ u.intereses_pagados|floatformat:0|intcomma }}</td>
                        <td class="text-end">${{ u.capital_pendiente|floatformat:0|intcomma }}</td>
                        <td class="text-end">{{ u.participacion|floatformat:0 }}%</td>
                        <td class="text-end">{{ u.dias_vinculacion|intcomma }}</td>

                        <td class="text-end">${{ u.intereses_ganados|floatformat:0|intcomma }}</td>
                        <td class="text-end">${{ u.recaudo_actividad|floatformat:0|intcomma }}</td>

                        <td class="text-end">{{ u.rentabilidad|floatformat:0 }}%</td>
                        <td class="text-center">
                            {% if u.ultimo_aporte %}{{ u.ultimo_aporte|date:"d/m/Y" }}{% else %}-{% endif %}
                        </td>
                        <td class="text-center">{{ u.estado_mora }}</td>
                        <td class="text-end">${{ u.pago_admin|floatformat:0|intcomma }}</td>
                        <td class="text-end">${{ u.intereses_neto|floatformat:0|intcomma }}</td>
                        <td class="text-end">${{ u.total_pagar|floatformat:0|intcomma }}</td>

                        <!-- ‚úÖ NUEVO: valor pagado por Admin APP -->
                        <td class="text-end">${{ u.admin_app_pagado|floatformat:0|intcomma }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="19" class="text-center">No hay socios con aportes en {{ a√±o_actual }}</td>
                    </tr>
                    {% endfor %}
                </tbody>

                <tfoot class="table-secondary fw-bold">
                    <tr>
                        <td colspan="4" class="text-center">TOTALES</td>

                        <td class="text-end">${{ totales.total_aportes|floatformat:0|intcomma }}</td>
                        <td class="text-end">${{ totales.total_aportes_viaje|floatformat:0|intcomma }}</td>

                        <td class="text-end">${{ totales.intereses_pagados|floatformat:0|intcomma }}</td>
                        <td class="text-end">${{ totales.capital_pendiente|floatformat:0|intcomma }}</td>
                        <td class="text-end">100%</td>
                        <td class="text-end">-</td>

                        <td class="text-end">${{ totales.intereses_ganados|floatformat:0|intcomma }}</td>
                        <td class="text-end">${{ totales.total_recaudo_actividad|floatformat:0|intcomma }}</td>

                        <td class="text-end">-</td>
                        <td>-</td>
                        <td>-</td>
                        <td class="text-end">${{ totales.pago_admin|floatformat:0|intcomma }}</td>
                        <td class="text-end">${{ totales.intereses_neto|floatformat:0|intcomma }}</td>
                        <td class="text-end">${{ totales.total_pagar|floatformat:0|intcomma }}</td>

                        <!-- ‚úÖ NUEVO: total admin app -->
                        <td class="text-end">${{ totales.admin_app_pagado|floatformat:0|intcomma }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- =========================
     RESUMEN DEL FONDO
========================== -->
<div class="row mt-4">
    <div class="col-md-6 offset-md-3">
        <div class="card">
            <div class="card-header bg-dark text-white">
                Resumen del Fondo {{ a√±o_actual }}
            </div>
            <div class="card-body">
                <p><strong>Total en el fondo:</strong> ${{ total_en_fondo|floatformat:0|intcomma }}</p>

                <form method="post">
                    {% csrf_token %}
                    <div class="mb-2">
                        <label class="form-label">Nequi</label>
                        <input type="number" class="form-control text-end" id="nequi" name="nequi"
                               value="{{ balance.nequi|floatformat:0 }}">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Efectivo</label>
                        <input type="number" class="form-control text-end" id="efectivo" name="efectivo"
                               value="{{ balance.efectivo|floatformat:0 }}">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Daviplata</label>
                        <input type="number" class="form-control text-end" id="daviplata" name="daviplata"
                               value="{{ balance.daviplata|floatformat:0 }}">
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Diferencia</label>
                        <input type="text" class="form-control text-end bg-light" id="diferencia" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Comentarios</label>
                        <textarea class="form-control" name="comentarios" rows="3">{{ balance.comentarios }}</textarea>
                    </div>

                    <div class="d-flex justify-content-between">
                        <small class="text-muted">
                            √öltima actualizaci√≥n: {{ balance.fecha_modificacion|date:"d/m/Y H:i" }}
                        </small>
                        <button type="submit" class="btn btn-primary">Guardar Balance</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function calcularDiferencia() {
    const fondo = {{ total_en_fondo|floatformat:0 }};
    const nequi = parseFloat(nequi.value) || 0;
    const efectivo = parseFloat(efectivo.value) || 0;
    const daviplata = parseFloat(daviplata.value) || 0;
    diferencia.value = new Intl.NumberFormat("es-CO").format(fondo - (nequi + efectivo + daviplata));
}
["nequi","efectivo","daviplata"].forEach(id=>{
    document.getElementById(id).addEventListener("input",calcularDiferencia)
});
calcularDiferencia();
</script>
{% endblock %}
